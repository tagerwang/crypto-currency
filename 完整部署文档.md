# MCP 加密货币服务完整部署文档

## 目录

1. [项目概述](#项目概述)
2. [SSH 连接配置](#ssh-连接配置)
3. [文件上传到服务器](#文件上传到服务器)
4. [服务器部署详解](#服务器部署详解)
5. [MCP HTTP 连接原理](#mcp-http-连接原理)
6. [本地 MCP vs 远程 MCP](#本地-mcp-vs-远程-mcp)
7. [后续更新部署](#后续更新部署)
8. [故障排查](#故障排查)

---

## 项目概述

### 架构说明

```
┌─────────────────────────────────────────────────────────────┐
│                    本地开发环境 (Mac)                        │
│                                                             │
│  ┌──────────────┐         ┌─────────────────────────┐      │
│  │  Kiro IDE    │         │  本地 MCP 配置          │      │
│  │  + Claude    │────────>│  ~/.kiro/settings/      │      │
│  │              │         │  mcp.json               │      │
│  └──────────────┘         └─────────────────────────┘      │
│         │                           │                       │
│         │ 开发/调试                  │ HTTP 请求             │
│         ▼                           ▼                       │
│  ┌──────────────────────────────────────────────────┐      │
│  │  项目代码                                         │      │
│  │  - binance_mcp.py                                │      │
│  │  - coingecko_mcp.py                              │      │
│  │  - mcp_http_server.py (HTTP 包装器)              │      │
│  └──────────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ SSH + rsync 部署
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              Vultr 服务器 (YOUR_SERVER_IP)                    │
│              Ubuntu 22.04 LTS - Singapore                   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Nginx (端口 80)                                     │   │
│  │  - 反向代理                                          │   │
│  │  - 负载均衡                                          │   │
│  └────────────────┬────────────────────────────────────┘   │
│                   │ 转发到 127.0.0.1:8080                  │
│                   ▼                                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Supervisor (进程管理)                               │   │
│  │  - 自动启动                                          │   │
│  │  - 崩溃重启                                          │   │
│  │  - 日志管理                                          │   │
│  └────────────────┬────────────────────────────────────┘   │
│                   │                                         │
│                   ▼                                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Python 虚拟环境                                     │   │
│  │  /opt/mcp-crypto-api/venv/                          │   │
│  │                                                      │   │
│  │  ┌──────────────────────────────────────────────┐   │   │
│  │  │  Flask HTTP Server (mcp_http_server.py)     │   │   │
│  │  │  监听 127.0.0.1:8080                         │   │   │
│  │  │                                              │   │   │
│  │  │  ┌────────────────┐  ┌──────────────────┐   │   │   │
│  │  │  │ binance_mcp.py │  │ coingecko_mcp.py │   │   │   │
│  │  │  │ - 币安 API     │  │ - CoinGecko API  │   │   │   │
│  │  │  │ - 资金费率     │  │ - 热门币种       │   │   │   │
│  │  │  │ - K线分析      │  │ - 价格查询       │   │   │   │
│  │  │  └────────────────┘  └──────────────────┘   │   │   │
│  │  └──────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  对外提供 HTTP API:                                         │
│  - http://YOUR_SERVER_IP/binance/spot/price?symbol=BTC       │
│  - http://YOUR_SERVER_IP/coingecko/trending                  │
└─────────────────────────────────────────────────────────────┘
```

### 工作流程

1. **开发阶段**：在本地 Mac 使用 Kiro + Claude 编写和调试代码
2. **部署阶段**：通过 SSH 将代码上传到服务器并自动配置
3. **运行阶段**：服务器 24/7 运行 HTTP API 服务
4. **使用阶段**：Kiro 通过 HTTP 调用服务器上的 MCP 功能

---

## SSH 连接配置

### 问题：直接 SSH 连接失败

当你执行 `ssh root@YOUR_SERVER_IP` 时，可能会看到警告：

```
The authenticity of host 'YOUR_SERVER_IP (YOUR_SERVER_IP)' can't be established.
ED25519 key fingerprint is SHA256:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])?
```

**这是正常的安全提示**，表示这是第一次连接到这台服务器。

### 解决方案 1：接受服务器指纹（推荐）


#### 步骤 1：首次连接

```bash
ssh root@YOUR_SERVER_IP
```

当看到提示时，输入 `yes` 并回车：

```
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
```

然后输入服务器密码（Vultr 提供的 root 密码）。

#### 步骤 2：SSH 工作原理

1. **首次连接**：
   - SSH 客户端连接到服务器
   - 服务器发送其公钥指纹
   - 你确认后，指纹被保存到 `~/.ssh/known_hosts`
   - 以后连接时会验证指纹是否匹配

2. **known_hosts 文件**：
   ```bash
   # 查看已保存的服务器指纹
   cat ~/.ssh/known_hosts | grep YOUR_SERVER_IP
   ```

3. **如果指纹不匹配**（服务器重装后）：
   ```bash
   # 删除旧指纹
   ssh-keygen -R YOUR_SERVER_IP
   # 重新连接
   ssh root@YOUR_SERVER_IP
   ```

### 解决方案 2：配置 SSH 免密登录（强烈推荐）

免密登录让你无需每次输入密码，且更安全。

#### 步骤 1：生成 SSH 密钥对

```bash
# 生成 RSA 密钥对（4096 位）
ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""
```

**参数说明**：
- `-t rsa`：密钥类型为 RSA
- `-b 4096`：密钥长度 4096 位（更安全）
- `-f ~/.ssh/id_rsa`：密钥保存位置
- `-N ""`：不设置密码短语（空密码）

**生成的文件**：
- `~/.ssh/id_rsa`：私钥（保密，不要分享）
- `~/.ssh/id_rsa.pub`：公钥（可以公开）

#### 步骤 2：复制公钥到服务器

```bash
ssh-copy-id -o StrictHostKeyChecking=no root@YOUR_SERVER_IP
```

**参数说明**：
- `ssh-copy-id`：自动将公钥复制到服务器
- `-o StrictHostKeyChecking=no`：跳过指纹确认（首次连接）
- `root@YOUR_SERVER_IP`：目标服务器

**这个命令做了什么**：
1. 读取 `~/.ssh/id_rsa.pub` 的内容
2. SSH 连接到服务器（需要输入密码）
3. 将公钥追加到服务器的 `~/.ssh/authorized_keys` 文件
4. 设置正确的文件权限

**输出示例**：
```
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/Users/wangtao/.ssh/id_rsa.pub"
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s)
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed
root@YOUR_SERVER_IP's password: [输入密码]

Number of key(s) added: 1

Now try logging into the machine with: "ssh 'root@YOUR_SERVER_IP'"
```

#### 步骤 3：测试免密登录

```bash
ssh root@YOUR_SERVER_IP
```

现在应该无需输入密码就能直接登录！


#### SSH 免密登录原理

```
┌─────────────────┐                    ┌──────────────────┐
│   本地 Mac      │                    │  服务器          │
│                 │                    │                  │
│  ~/.ssh/        │                    │  ~/.ssh/         │
│  ├─ id_rsa      │ (私钥，保密)       │  └─ authorized_  │
│  │  (私钥)      │                    │     keys         │
│  └─ id_rsa.pub  │ (公钥，可公开)     │     (公钥列表)   │
│     (公钥)      │                    │                  │
└────────┬────────┘                    └────────┬─────────┘
         │                                      │
         │  1. 发起连接请求                      │
         │─────────────────────────────────────>│
         │                                      │
         │  2. 服务器发送随机挑战                │
         │<─────────────────────────────────────│
         │                                      │
         │  3. 用私钥签名挑战                    │
         │─────────────────────────────────────>│
         │                                      │
         │  4. 服务器用公钥验证签名              │
         │     验证成功 -> 允许登录              │
         │<─────────────────────────────────────│
         │                                      │
```

**安全性**：
- 私钥永远不离开本地
- 即使公钥泄露，也无法伪造签名
- 比密码更安全（密码可能被暴力破解）

### SSH 配置文件（可选）

创建 `~/.ssh/config` 简化连接：

```bash
cat >> ~/.ssh/config << 'EOF'
Host mcp-server
    HostName YOUR_SERVER_IP
    User root
    IdentityFile ~/.ssh/id_rsa
    ServerAliveInterval 60
    ServerAliveCountMax 3
EOF
```

**配置说明**：
- `Host mcp-server`：别名，可以用 `ssh mcp-server` 连接
- `HostName`：实际 IP 地址
- `User`：登录用户名
- `IdentityFile`：使用的私钥
- `ServerAliveInterval`：每 60 秒发送心跳包
- `ServerAliveCountMax`：3 次心跳失败后断开

**使用别名连接**：
```bash
ssh mcp-server  # 等同于 ssh root@YOUR_SERVER_IP
```

---

## 文件上传到服务器

### 方法 1：使用 rsync（推荐）

rsync 是增量同步工具，只传输变化的文件，速度快且可靠。

#### 基本用法

```bash
rsync -avz --progress \
    --exclude '__pycache__' \
    --exclude '*.pyc' \
    --exclude '.git' \
    --exclude 'venv' \
    --exclude '.DS_Store' \
    ./* root@YOUR_SERVER_IP:/opt/mcp-crypto-api/
```

#### 参数详解

**基本参数**：
- `-a` (archive)：归档模式，保留权限、时间戳等
  - 等同于 `-rlptgoD`
  - `-r`：递归复制目录
  - `-l`：复制符号链接
  - `-p`：保留权限
  - `-t`：保留修改时间
  - `-g`：保留组
  - `-o`：保留所有者
  - `-D`：保留设备文件
- `-v` (verbose)：显示详细信息
- `-z` (compress)：传输时压缩数据

**进度显示**：
- `--progress`：显示每个文件的传输进度

**排除文件**：
- `--exclude '__pycache__'`：排除 Python 缓存目录
- `--exclude '*.pyc'`：排除编译的 Python 文件
- `--exclude '.git'`：排除 Git 仓库（通常很大）
- `--exclude 'venv'`：排除虚拟环境（服务器会重新创建）
- `--exclude '.DS_Store'`：排除 macOS 系统文件

**源和目标**：
- `./*`：当前目录的所有文件
- `root@YOUR_SERVER_IP:/opt/mcp-crypto-api/`：目标服务器路径


#### rsync 工作原理

```
本地文件系统                          服务器文件系统
┌──────────────┐                     ┌──────────────┐
│ file1.py     │  1. 计算校验和       │ file1.py     │
│ (已修改)     │─────────────────────>│ (旧版本)     │
│              │  2. 比较差异         │              │
│              │  3. 只传输变化部分   │              │
│              │─────────────────────>│              │
│              │                      │ (已更新)     │
├──────────────┤                     ├──────────────┤
│ file2.py     │  1. 校验和相同       │ file2.py     │
│ (未修改)     │  2. 跳过传输         │ (相同)       │
├──────────────┤                     ├──────────────┤
│ file3.py     │  1. 服务器不存在     │              │
│ (新文件)     │  2. 完整传输         │              │
│              │─────────────────────>│ file3.py     │
│              │                      │ (新创建)     │
└──────────────┘                     └──────────────┘
```

**优势**：
- 只传输变化的部分，节省时间和带宽
- 支持断点续传
- 保留文件属性
- 可以删除目标端多余的文件（使用 `--delete`）

#### 输出示例

```
sending incremental file list
binance_mcp.py
      81,234 100%   72.9KB/s   00:01
mcp_http_server.py
       7,459 100%   17.9KB/s   00:00
requirements.txt
          59 100%    0.2KB/s   00:00

sent 89,752 bytes  received 72 bytes  59,882.67 bytes/sec
total size is 282,738  speedup is 3.15
```

**解读**：
- `sending incremental file list`：发送增量文件列表
- 每行显示：文件名、大小、进度、速度、时间
- `sent X bytes`：发送的数据量
- `speedup is 3.15`：压缩比（实际传输量是文件总大小的 1/3.15）

### 方法 2：使用 SCP

SCP 是简单的文件复制工具，适合一次性传输。

```bash
# 复制单个文件
scp mcp_http_server.py root@YOUR_SERVER_IP:/opt/mcp-crypto-api/

# 复制整个目录
scp -r ./* root@YOUR_SERVER_IP:/opt/mcp-crypto-api/
```

**参数**：
- `-r`：递归复制目录
- `-P 22`：指定端口（默认 22）
- `-C`：启用压缩

**缺点**：
- 每次都传输所有文件（不支持增量）
- 不能排除特定文件
- 速度较慢

### 方法 3：使用 Git（最专业）

如果项目使用 Git 管理：

```bash
# 在本地提交代码
git add .
git commit -m "更新功能"
git push origin main

# 在服务器上拉取
ssh root@YOUR_SERVER_IP
cd /opt/mcp-crypto-api
git pull origin main
```

**优势**：
- 版本控制
- 可以回滚
- 团队协作
- 自动化部署（配合 Git Hooks）

### 自动化部署脚本

我们创建的 `deploy_simple.sh` 封装了上传和部署：

```bash
#!/bin/bash
SERVER_IP="YOUR_SERVER_IP"
SERVER_USER="root"
PROJECT_DIR="/opt/mcp-crypto-api"

# 上传文件
rsync -avz --progress \
    --exclude '__pycache__' \
    --exclude '*.pyc' \
    --exclude '.git' \
    --exclude 'venv' \
    ./* $SERVER_USER@$SERVER_IP:$PROJECT_DIR/

# 在服务器上执行部署
ssh $SERVER_USER@$SERVER_IP "cd $PROJECT_DIR && ./quick_deploy.sh"
```

**使用方法**：
```bash
chmod +x deploy_simple.sh
./deploy_simple.sh
```


---

## 服务器部署详解

### 部署脚本：quick_deploy.sh

这个脚本自动完成所有服务器配置，让我们逐步分析它做了什么。

#### 步骤 1：更新系统

```bash
apt update -qq
```

**作用**：
- 更新软件包索引
- `-qq`：静默模式，减少输出

**原理**：
- Ubuntu 使用 APT（Advanced Package Tool）管理软件
- `apt update` 从软件源下载最新的包列表
- 不会安装或升级任何软件，只是更新索引

#### 步骤 2：安装依赖软件

```bash
apt install -y python3 python3-pip python3-venv nginx supervisor
```

**安装的软件**：

1. **python3**：Python 3 解释器
   - 运行我们的 Python 代码
   - Ubuntu 22.04 默认是 Python 3.10

2. **python3-pip**：Python 包管理器
   - 安装 Flask、requests 等 Python 库
   - 命令：`pip install package_name`

3. **python3-venv**：虚拟环境模块
   - 创建隔离的 Python 环境
   - 避免不同项目的依赖冲突

4. **nginx**：Web 服务器和反向代理
   - 监听 80 端口（HTTP）
   - 将请求转发到 Flask 应用（8080 端口）
   - 提供负载均衡、SSL 终止等功能

5. **supervisor**：进程管理工具
   - 自动启动应用
   - 崩溃后自动重启
   - 管理日志

**参数**：
- `-y`：自动确认，不询问

#### 步骤 3：创建项目目录

```bash
PROJECT_DIR="/opt/mcp-crypto-api"
mkdir -p $PROJECT_DIR
cd $PROJECT_DIR
```

**目录结构**：
```
/opt/mcp-crypto-api/
├── binance_mcp.py              # 币安 MCP 服务
├── coingecko_mcp.py            # CoinGecko MCP 服务
├── mcp_http_server.py          # HTTP 服务器（Flask）
├── requirements.txt            # Python 依赖列表
├── quick_deploy.sh             # 部署脚本
├── binance_mcp/                # 币安模块目录
│   ├── __init__.py
│   ├── api.py
│   ├── analysis.py
│   └── ...
└── venv/                       # Python 虚拟环境（稍后创建）
    ├── bin/
    ├── lib/
    └── ...
```

**为什么用 /opt**：
- `/opt` 是 Linux 标准目录，用于安装第三方软件
- 与系统软件分离，便于管理
- 权限清晰

#### 步骤 4：创建 Python 虚拟环境

```bash
python3 -m venv venv
```

**虚拟环境原理**：

```
系统 Python                      虚拟环境
┌─────────────────┐             ┌─────────────────┐
│ /usr/bin/       │             │ venv/bin/       │
│ └─ python3      │             │ └─ python3 ─────┼──> 链接到系统 Python
│                 │             │    pip          │
│ /usr/lib/       │             │                 │
│ └─ python3.10/  │             │ venv/lib/       │
│    └─ site-     │             │ └─ python3.10/  │
│       packages/ │             │    └─ site-     │
│       (系统包)  │             │       packages/ │
│                 │             │       (项目包)  │
└─────────────────┘             └─────────────────┘
```

**作用**：
- 隔离项目依赖
- 不污染系统 Python
- 不同项目可以使用不同版本的库

**激活虚拟环境**：
```bash
source venv/bin/activate
# 提示符变为：(venv) root@server:~#
```

#### 步骤 5：安装 Python 依赖

```bash
$PROJECT_DIR/venv/bin/pip install --quiet -r requirements.txt
```

**requirements.txt 内容**：
```
flask==3.0.0
flask-cors==4.0.0
requests==2.31.0
mcp>=1.0.0
```

**依赖说明**：

1. **Flask**：轻量级 Web 框架
   - 创建 HTTP API
   - 路由管理
   - 请求处理

2. **Flask-CORS**：跨域资源共享
   - 允许浏览器跨域访问 API
   - 配置 CORS 头

3. **requests**：HTTP 客户端库
   - 调用币安、CoinGecko API
   - 简化 HTTP 请求

4. **mcp**：Model Context Protocol SDK
   - MCP 协议实现
   - 工具注册和调用

**安装过程**：
```
Collecting flask==3.0.0
  Downloading flask-3.0.0-py3-none-any.whl (99 kB)
Collecting Werkzeug>=3.0.0
  Downloading werkzeug-3.0.1-py3-none-any.whl (226 kB)
...
Installing collected packages: ...
Successfully installed flask-3.0.0 flask-cors-4.0.0 ...
```


#### 步骤 6：配置 Supervisor（进程管理）

```bash
cat > /etc/supervisor/conf.d/mcp-crypto-api.conf <<EOF
[program:mcp-crypto-api]
directory=$PROJECT_DIR
command=$PROJECT_DIR/venv/bin/python mcp_http_server.py
user=root
autostart=true
autorestart=true
stderr_logfile=/var/log/mcp-crypto-api.err.log
stdout_logfile=/var/log/mcp-crypto-api.out.log
environment=PORT=8080
EOF
```

**配置详解**：

- `[program:mcp-crypto-api]`：程序名称
- `directory`：工作目录
- `command`：启动命令
  - 使用虚拟环境的 Python
  - 运行 `mcp_http_server.py`
- `user=root`：以 root 用户运行
- `autostart=true`：系统启动时自动启动
- `autorestart=true`：崩溃后自动重启
- `stderr_logfile`：错误日志位置
- `stdout_logfile`：标准输出日志位置
- `environment=PORT=8080`：环境变量

**Supervisor 工作原理**：

```
系统启动
   │
   ▼
┌─────────────────────┐
│  Supervisor Daemon  │
│  (supervisord)      │
└──────────┬──────────┘
           │
           │ 读取配置
           ▼
┌─────────────────────────────────────┐
│  /etc/supervisor/conf.d/            │
│  └─ mcp-crypto-api.conf             │
└──────────┬──────────────────────────┘
           │
           │ 启动进程
           ▼
┌─────────────────────────────────────┐
│  Python Process                     │
│  PID: 3899                          │
│  Command: python mcp_http_server.py │
│  Status: RUNNING                    │
└──────────┬──────────────────────────┘
           │
           │ 监控
           ▼
    进程崩溃？
       │
       ├─ 是 ──> 自动重启
       └─ 否 ──> 继续监控
```

**Supervisor 命令**：
```bash
# 重新加载配置
supervisorctl reread
supervisorctl update

# 查看状态
supervisorctl status mcp-crypto-api

# 启动/停止/重启
supervisorctl start mcp-crypto-api
supervisorctl stop mcp-crypto-api
supervisorctl restart mcp-crypto-api

# 查看日志
supervisorctl tail mcp-crypto-api
supervisorctl tail -f mcp-crypto-api  # 实时查看
```

#### 步骤 7：配置 Nginx（反向代理）

```bash
cat > /etc/nginx/sites-available/mcp-crypto-api <<EOF
server {
    listen 80;
    server_name _;

    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
EOF
```

**配置详解**：

- `listen 80`：监听 80 端口（HTTP）
- `server_name _`：匹配所有域名/IP
- `location /`：匹配所有路径
- `proxy_pass http://127.0.0.1:8080`：转发到本地 8080 端口
- `proxy_set_header`：设置转发的 HTTP 头
  - `Host`：原始请求的主机名
  - `X-Real-IP`：客户端真实 IP
  - `X-Forwarded-For`：代理链中的 IP 列表
- `proxy_*_timeout`：超时设置（60 秒）

**Nginx 工作流程**：

```
客户端请求
   │
   │ http://YOUR_SERVER_IP/binance/spot/price?symbol=BTC
   ▼
┌─────────────────────────────────────┐
│  Nginx (端口 80)                    │
│  - 接收请求                         │
│  - 解析 URL                         │
│  - 匹配 location 规则               │
└──────────┬──────────────────────────┘
           │
           │ 反向代理
           ▼
┌─────────────────────────────────────┐
│  Flask App (127.0.0.1:8080)         │
│  - 处理请求                         │
│  - 调用 binance_mcp.py              │
│  - 返回 JSON 响应                   │
└──────────┬──────────────────────────┘
           │
           │ 响应
           ▼
┌─────────────────────────────────────┐
│  Nginx                              │
│  - 接收响应                         │
│  - 添加响应头                       │
│  - 返回给客户端                     │
└──────────┬──────────────────────────┘
           │
           ▼
客户端收到响应
```

**为什么需要 Nginx**：

1. **端口管理**：
   - Flask 运行在 8080（非标准端口）
   - Nginx 监听 80（标准 HTTP 端口）
   - 用户访问时不需要指定端口

2. **安全性**：
   - Flask 不直接暴露在公网
   - Nginx 可以过滤恶意请求
   - 可以配置 SSL/TLS

3. **性能**：
   - Nginx 处理静态文件更快
   - 可以启用缓存
   - 支持负载均衡

4. **灵活性**：
   - 可以配置多个后端
   - URL 重写
   - 访问控制

**启用站点**：
```bash
# 创建符号链接
ln -sf /etc/nginx/sites-available/mcp-crypto-api /etc/nginx/sites-enabled/

# 删除默认站点
rm -f /etc/nginx/sites-enabled/default

# 测试配置
nginx -t

# 重启 Nginx
systemctl restart nginx
```


#### 步骤 8：配置防火墙

```bash
ufw --force enable
ufw allow 22/tcp    # SSH
ufw allow 80/tcp    # HTTP
ufw allow 443/tcp   # HTTPS
```

**UFW（Uncomplicated Firewall）**：

```
外部网络                         服务器
   │                              │
   │ SSH (22)                     │
   ├──────────────────────────────┤ ✅ 允许
   │                              │
   │ HTTP (80)                    │
   ├──────────────────────────────┤ ✅ 允许
   │                              │
   │ HTTPS (443)                  │
   ├──────────────────────────────┤ ✅ 允许
   │                              │
   │ 其他端口 (如 8080, 3306)     │
   ├──────────────────────────────┤ ❌ 拒绝
   │                              │
```

**规则说明**：
- 端口 22：SSH 连接（必须开放，否则无法远程管理）
- 端口 80：HTTP 访问（API 服务）
- 端口 443：HTTPS 访问（如果配置 SSL）
- 其他端口：默认拒绝（包括 8080，Flask 只能本地访问）

**查看防火墙状态**：
```bash
ufw status verbose
```

**输出示例**：
```
Status: active
Logging: on (low)
Default: deny (incoming), allow (outgoing), disabled (routed)

To                         Action      From
--                         ------      ----
22/tcp                     ALLOW IN    Anywhere
80/tcp                     ALLOW IN    Anywhere
443/tcp                    ALLOW IN    Anywhere
```

#### 步骤 9：启动服务

```bash
# 重新加载 Supervisor 配置
supervisorctl reread
supervisorctl update
supervisorctl start mcp-crypto-api

# 重启 Nginx
nginx -t && systemctl restart nginx
```

**启动流程**：

```
1. supervisorctl reread
   └─> 读取 /etc/supervisor/conf.d/ 下的新配置

2. supervisorctl update
   └─> 应用配置变更
       └─> 启动新程序

3. supervisorctl start mcp-crypto-api
   └─> 启动 Python 进程
       └─> 执行: venv/bin/python mcp_http_server.py
           └─> Flask 应用启动
               └─> 监听 127.0.0.1:8080

4. nginx -t
   └─> 测试 Nginx 配置语法

5. systemctl restart nginx
   └─> 重启 Nginx 服务
       └─> 监听 0.0.0.0:80
           └─> 准备接收外部请求
```

#### 验证部署

```bash
# 1. 检查进程
ps aux | grep mcp_http_server
# 输出：root  3899  python mcp_http_server.py

# 2. 检查端口
netstat -tlnp | grep 8080
# 输出：tcp  0  0  127.0.0.1:8080  0.0.0.0:*  LISTEN  3899/python

netstat -tlnp | grep 80
# 输出：tcp  0  0  0.0.0.0:80  0.0.0.0:*  LISTEN  1234/nginx

# 3. 测试本地访问
curl http://localhost:8080/health
# 输出：{"status": "ok", "service": "MCP Crypto API"}

curl http://localhost/health
# 输出：{"status": "ok", "service": "MCP Crypto API"}

# 4. 测试外部访问（在本地 Mac 执行）
curl http://YOUR_SERVER_IP/health
# 输出：{"status": "ok", "service": "MCP Crypto API"}
```

### 完整的服务架构

```
┌─────────────────────────────────────────────────────────────┐
│                    服务器 (YOUR_SERVER_IP)                    │
│                                                             │
│  ┌───────────────────────────────────────────────────┐     │
│  │  UFW 防火墙                                       │     │
│  │  - 允许 22, 80, 443                               │     │
│  │  - 拒绝其他端口                                   │     │
│  └────────────────────┬──────────────────────────────┘     │
│                       │                                     │
│                       ▼                                     │
│  ┌───────────────────────────────────────────────────┐     │
│  │  Nginx (0.0.0.0:80)                               │     │
│  │  - 接收外部请求                                   │     │
│  │  - 反向代理到 127.0.0.1:8080                      │     │
│  └────────────────────┬──────────────────────────────┘     │
│                       │                                     │
│                       ▼                                     │
│  ┌───────────────────────────────────────────────────┐     │
│  │  Supervisor                                       │     │
│  │  - 管理 Python 进程                               │     │
│  │  - 自动重启                                       │     │
│  │  - 日志管理                                       │     │
│  └────────────────────┬──────────────────────────────┘     │
│                       │                                     │
│                       ▼                                     │
│  ┌───────────────────────────────────────────────────┐     │
│  │  Python 虚拟环境 (venv)                           │     │
│  │                                                   │     │
│  │  ┌─────────────────────────────────────────┐     │     │
│  │  │  Flask App (127.0.0.1:8080)             │     │     │
│  │  │  mcp_http_server.py                     │     │     │
│  │  │                                         │     │     │
│  │  │  ┌──────────────┐  ┌─────────────────┐ │     │     │
│  │  │  │ binance_mcp  │  │ coingecko_mcp   │ │     │     │
│  │  │  │              │  │                 │ │     │     │
│  │  │  │ - API 调用   │  │ - API 调用      │ │     │     │
│  │  │  │ - 数据分析   │  │ - 数据查询      │ │     │     │
│  │  │  └──────────────┘  └─────────────────┘ │     │     │
│  │  └─────────────────────────────────────────┘     │     │
│  └───────────────────────────────────────────────────┘     │
│                                                             │
│  日志文件：                                                 │
│  - /var/log/mcp-crypto-api.out.log                         │
│  - /var/log/mcp-crypto-api.err.log                         │
│  - /var/log/nginx/access.log                               │
│  - /var/log/nginx/error.log                                │
└─────────────────────────────────────────────────────────────┘
```


---

## MCP HTTP 连接原理

### MCP 协议简介

MCP (Model Context Protocol) 是一个标准化协议，用于 AI 模型与外部工具的通信。

**两种连接方式**：

1. **本地进程（Stdio）**：
   - AI 启动一个子进程
   - 通过标准输入/输出通信
   - 适合本地工具

2. **HTTP 服务器**：
   - AI 通过 HTTP 请求调用工具
   - 工具运行在远程服务器
   - 适合云服务

### 本地 MCP 配置

```json
{
  "mcpServers": {
    "binance-local": {
      "command": "/opt/homebrew/bin/python3",
      "args": ["-m", "binance_mcp"],
      "cwd": "/Users/wangtao/exercise/crypto-currency-main",
      "env": {
        "PYTHONPATH": "/Users/wangtao/exercise/crypto-currency-main"
      }
    }
  }
}
```

**工作流程**：

```
┌─────────────────────────────────────────────────────────────┐
│  Kiro / Claude                                              │
│                                                             │
│  1. 用户请求："获取 BTC 价格"                                │
│     │                                                       │
│     ▼                                                       │
│  2. 决定调用 MCP 工具                                       │
│     │                                                       │
│     ▼                                                       │
│  3. 启动子进程                                              │
│     └─> fork()                                             │
│         └─> exec("/opt/homebrew/bin/python3 -m binance_mcp")│
│                                                             │
│  ┌───────────────────────────────────────────────────┐     │
│  │  子进程 (binance_mcp)                             │     │
│  │  - 监听 stdin                                     │     │
│  │  - 输出到 stdout                                  │     │
│  └───────────────────────────────────────────────────┘     │
│     │                                                       │
│     ▼                                                       │
│  4. 发送 JSON-RPC 请求到 stdin                              │
│     {                                                       │
│       "jsonrpc": "2.0",                                     │
│       "method": "tools/call",                               │
│       "params": {                                           │
│         "name": "get_spot_price",                           │
│         "arguments": {"symbol": "BTC"}                      │
│       }                                                     │
│     }                                                       │
│     │                                                       │
│     ▼                                                       │
│  5. 子进程处理请求                                          │
│     - 调用币安 API                                          │
│     - 获取价格数据                                          │
│     │                                                       │
│     ▼                                                       │
│  6. 返回 JSON-RPC 响应到 stdout                             │
│     {                                                       │
│       "jsonrpc": "2.0",                                     │
│       "result": {                                           │
│         "symbol": "BTCUSDT",                                │
│         "price": 92731.52                                   │
│       }                                                     │
│     }                                                       │
│     │                                                       │
│     ▼                                                       │
│  7. Kiro 读取响应                                           │
│     │                                                       │
│     ▼                                                       │
│  8. 显示给用户："BTC 价格：$92,731.52"                      │
└─────────────────────────────────────────────────────────────┘
```

**优点**：
- 简单直接
- 无需网络
- 低延迟

**缺点**：
- 占用本地资源
- 每次调用都启动新进程
- 无法共享状态

### 远程 MCP 配置

```json
{
  "mcpServers": {
    "binance-remote": {
      "type": "http",
      "url": "http://YOUR_SERVER_IP"
    }
  }
}
```

**工作流程**：

```
┌─────────────────────────────────────────────────────────────┐
│  Kiro / Claude (本地 Mac)                                   │
│                                                             │
│  1. 用户请求："获取 BTC 价格"                                │
│     │                                                       │
│     ▼                                                       │
│  2. 决定调用 MCP 工具                                       │
│     │                                                       │
│     ▼                                                       │
│  3. 发送 HTTP POST 请求                                     │
│     POST http://YOUR_SERVER_IP/mcp                            │
│     Content-Type: application/json                          │
│     {                                                       │
│       "jsonrpc": "2.0",                                     │
│       "method": "tools/call",                               │
│       "params": {                                           │
│         "name": "get_spot_price",                           │
│         "arguments": {"symbol": "BTC"}                      │
│       }                                                     │
│     }                                                       │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       │ 互联网
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  服务器 (YOUR_SERVER_IP)                                      │
│                                                             │
│  ┌───────────────────────────────────────────────────┐     │
│  │  Nginx (端口 80)                                  │     │
│  │  - 接收 HTTP 请求                                 │     │
│  │  - 转发到 Flask                                   │     │
│  └────────────────────┬──────────────────────────────┘     │
│                       │                                     │
│                       ▼                                     │
│  ┌───────────────────────────────────────────────────┐     │
│  │  Flask App (mcp_http_server.py)                   │     │
│  │                                                   │     │
│  │  4. 解析请求                                      │     │
│  │     - 提取 method: "tools/call"                   │     │
│  │     - 提取 tool name: "get_spot_price"            │     │
│  │     - 提取 arguments: {"symbol": "BTC"}           │     │
│  │     │                                             │     │
│  │     ▼                                             │     │
│  │  5. 路由到对应函数                                │     │
│  │     - 查找 binance_mcp.get_spot_price()           │     │
│  │     │                                             │     │
│  │     ▼                                             │     │
│  │  ┌─────────────────────────────────────────┐     │     │
│  │  │  binance_mcp.py                         │     │     │
│  │  │                                         │     │     │
│  │  │  def get_spot_price(symbol):            │     │     │
│  │  │      # 调用币安 API                     │     │     │
│  │  │      response = requests.get(           │     │     │
│  │  │          "https://api.binance.com/..."  │     │     │
│  │  │      )                                   │     │     │
│  │  │      return response.json()             │     │     │
│  │  └─────────────────────────────────────────┘     │     │
│  │     │                                             │     │
│  │     ▼                                             │     │
│  │  6. 返回 JSON 响应                                │     │
│  │     {                                             │     │
│  │       "jsonrpc": "2.0",                           │     │
│  │       "result": {                                 │     │
│  │         "symbol": "BTCUSDT",                      │     │
│  │         "price": 92731.52                         │     │
│  │       }                                           │     │
│  │     }                                             │     │
│  └───────────────────────────────────────────────────┘     │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       │ HTTP 响应
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  Kiro / Claude                                              │
│                                                             │
│  7. 接收响应                                                │
│     │                                                       │
│     ▼                                                       │
│  8. 显示给用户："BTC 价格：$92,731.52"                      │
└─────────────────────────────────────────────────────────────┘
```


### HTTP 服务器实现：mcp_http_server.py

让我们详细分析 HTTP 包装器的实现：

```python
from flask import Flask, request, jsonify
from flask_cors import CORS
import sys
import os

# 添加当前目录到 Python 路径
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

app = Flask(__name__)
CORS(app)  # 允许跨域访问

# 导入 MCP 服务的功能
from binance_mcp import (
    get_spot_price, get_ticker_24h, get_klines,
    comprehensive_analysis, analyze_kline_patterns,
    # ... 其他函数
)

from coingecko_mcp import get_price, get_coin_data, search_coins, get_trending
```

**关键点**：

1. **导入 MCP 函数**：
   - 直接导入 `binance_mcp.py` 和 `coingecko_mcp.py` 中的函数
   - 这些函数原本是为 MCP stdio 协议设计的
   - 现在通过 HTTP 暴露出来

2. **CORS 配置**：
   - 允许浏览器跨域访问
   - 前端应用可以直接调用 API

#### API 路由映射

```python
@app.route('/binance/spot/price', methods=['GET'])
def binance_spot_price():
    symbol = request.args.get('symbol', 'BTC')
    result = get_spot_price(symbol)
    return jsonify(result)
```

**工作原理**：

1. **路由定义**：
   - `@app.route('/binance/spot/price')`：定义 URL 路径
   - `methods=['GET']`：只接受 GET 请求

2. **参数提取**：
   - `request.args.get('symbol', 'BTC')`：从 URL 查询参数获取 symbol
   - 默认值为 'BTC'

3. **调用 MCP 函数**：
   - `get_spot_price(symbol)`：调用原始的 MCP 函数
   - 函数返回 Python 字典

4. **返回 JSON**：
   - `jsonify(result)`：将 Python 字典转换为 JSON 响应
   - 自动设置 `Content-Type: application/json`

#### 完整的请求流程

```
HTTP 请求
   │
   │ GET /binance/spot/price?symbol=BTC
   ▼
┌─────────────────────────────────────────────────────────────┐
│  Flask 路由系统                                             │
│                                                             │
│  1. URL 匹配                                                │
│     /binance/spot/price  ──>  binance_spot_price()         │
│                                                             │
│  2. 提取参数                                                │
│     request.args.get('symbol')  ──>  'BTC'                 │
│                                                             │
│  3. 调用函数                                                │
│     get_spot_price('BTC')                                   │
│     │                                                       │
│     ▼                                                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  binance_mcp.py                                     │   │
│  │                                                     │   │
│  │  def get_spot_price(symbol):                        │   │
│  │      # 标准化交易对                                 │   │
│  │      if not symbol.endswith('USDT'):                │   │
│  │          symbol = f"{symbol}USDT"                   │   │
│  │                                                     │   │
│  │      # 调用币安 API                                 │   │
│  │      url = "https://api.binance.com/api/v3/ticker/price"│
│  │      params = {"symbol": symbol}                    │   │
│  │      response = requests.get(url, params=params)    │   │
│  │                                                     │   │
│  │      # 解析响应                                     │   │
│  │      data = response.json()                         │   │
│  │      price = float(data['price'])                   │   │
│  │                                                     │   │
│  │      # 返回格式化结果                               │   │
│  │      return {                                       │   │
│  │          "symbol": symbol,                          │   │
│  │          "price": price,                            │   │
│  │          "price_formatted": f"${price:,.4f}",       │   │
│  │          "market": "现货"                           │   │
│  │      }                                              │   │
│  └─────────────────────────────────────────────────────┘   │
│     │                                                       │
│     ▼                                                       │
│  4. 返回结果                                                │
│     {                                                       │
│       "symbol": "BTCUSDT",                                  │
│       "price": 92731.52,                                    │
│       "price_formatted": "$92,731.5200",                    │
│       "market": "现货"                                      │
│     }                                                       │
│     │                                                       │
│     ▼                                                       │
│  5. JSON 序列化                                             │
│     jsonify(result)                                         │
│     │                                                       │
│     ▼                                                       │
│  6. 设置 HTTP 响应头                                        │
│     Content-Type: application/json                          │
│     Content-Length: 123                                     │
└─────────────────────────────────────────────────────────────┘
   │
   ▼
HTTP 响应
```

### autoApprove 工作原理

在 MCP 配置中，`autoApprove` 列表指定了哪些工具可以自动执行，无需用户确认。

```json
{
  "binance-remote": {
    "type": "http",
    "url": "http://YOUR_SERVER_IP",
    "autoApprove": [
      "get_spot_price",
      "get_ticker_24h",
      "comprehensive_analysis"
    ]
  }
}
```

**工作流程**：

```
┌─────────────────────────────────────────────────────────────┐
│  Kiro / Claude                                              │
│                                                             │
│  1. 用户请求："获取 BTC 价格"                                │
│     │                                                       │
│     ▼                                                       │
│  2. AI 分析请求                                             │
│     - 需要调用工具：get_spot_price                          │
│     - 参数：{"symbol": "BTC"}                               │
│     │                                                       │
│     ▼                                                       │
│  3. 检查 autoApprove 列表                                   │
│     ┌─────────────────────────────────────────┐            │
│     │ autoApprove 包含 "get_spot_price"？     │            │
│     └─────────────┬───────────────────────────┘            │
│                   │                                         │
│         ┌─────────┴─────────┐                               │
│         │                   │                               │
│        是                  否                               │
│         │                   │                               │
│         ▼                   ▼                               │
│  ┌──────────────┐    ┌──────────────────┐                  │
│  │ 自动执行     │    │ 询问用户确认     │                  │
│  │ (无需等待)   │    │ "是否允许调用    │                  │
│  │              │    │  get_spot_price?"│                  │
│  └──────┬───────┘    └────────┬─────────┘                  │
│         │                     │                             │
│         │              用户点击"允许"                        │
│         │                     │                             │
│         └──────────┬──────────┘                             │
│                    │                                        │
│                    ▼                                        │
│  4. 发送 HTTP 请求到服务器                                  │
│     GET http://YOUR_SERVER_IP/binance/spot/price?symbol=BTC   │
│     │                                                       │
│     ▼                                                       │
│  5. 接收响应并显示                                          │
└─────────────────────────────────────────────────────────────┘
```


**autoApprove 的作用**：

1. **提升用户体验**：
   - 常用、安全的工具自动执行
   - 减少重复确认
   - 加快响应速度

2. **安全控制**：
   - 危险操作（如删除、修改）不加入列表
   - 用户仍需手动确认
   - 防止意外操作

3. **灵活配置**：
   - 可以随时添加/删除工具
   - 不同 MCP 服务器可以有不同的列表

### 工具发现机制

当 Kiro 连接到 MCP 服务器时，会发送 `tools/list` 请求获取可用工具列表。

**HTTP MCP 服务器的工具列表端点**：

```python
@app.route('/', methods=['GET'])
def api_docs():
    """API 文档"""
    return jsonify({
        "service": "MCP Crypto API Server",
        "version": "1.0.0",
        "endpoints": {
            "health": "GET /health",
            "binance": {
                "spot_price": "GET /binance/spot/price?symbol=BTC",
                "ticker_24h": "GET /binance/ticker/24h?symbol=BTC",
                "klines": "GET /binance/klines?symbol=BTC&interval=1h",
                # ... 更多端点
            },
            "coingecko": {
                "price": "GET /coingecko/price?coin_ids=bitcoin",
                "trending": "GET /coingecko/trending",
                # ... 更多端点
            }
        }
    })
```

**工具发现流程**：

```
Kiro 启动
   │
   ▼
读取 mcp.json 配置
   │
   ├─> binance-remote: http://YOUR_SERVER_IP
   └─> coingecko-remote: http://YOUR_SERVER_IP
   │
   ▼
发送 GET / 请求
   │
   ▼
接收工具列表
   │
   ├─> binance.spot_price
   ├─> binance.ticker_24h
   ├─> binance.klines
   ├─> coingecko.price
   └─> coingecko.trending
   │
   ▼
注册工具到 AI 上下文
   │
   ▼
AI 可以调用这些工具
```

---

## 本地 MCP vs 远程 MCP

### 详细对比

| 特性 | 本地 MCP | 远程 MCP (HTTP) |
|------|----------|-----------------|
| **连接方式** | 进程通信 (stdin/stdout) | HTTP 请求 |
| **配置** | `command` + `args` | `type: http` + `url` |
| **进程管理** | Kiro 启动子进程 | 服务器独立运行 |
| **资源占用** | 占用本地 CPU/内存 | 占用服务器资源 |
| **启动时间** | 每次调用启动新进程 (~1-2秒) | 服务已运行 (~50ms) |
| **网络延迟** | 无 | 有（新加坡 ~50ms） |
| **可用性** | 依赖本地环境 | 24/7 可用 |
| **共享性** | 仅本机可用 | 多设备共享 |
| **调试** | 容易（本地日志） | 需要 SSH 查看日志 |
| **更新** | 修改本地文件即可 | 需要部署到服务器 |
| **成本** | 免费 | 服务器费用 (~$10/月) |
| **安全性** | 高（本地运行） | 需要配置防火墙 |
| **API 速度** | 取决于本地网络 | 服务器靠近交易所，更快 |

### 本地 MCP 详细流程

```
用户请求
   │
   ▼
┌─────────────────────────────────────────────────────────────┐
│  Kiro 进程 (PID: 1234)                                      │
│                                                             │
│  1. 解析用户请求                                            │
│     "获取 BTC 价格"                                         │
│     │                                                       │
│     ▼                                                       │
│  2. 决定调用 MCP 工具                                       │
│     工具：get_spot_price                                    │
│     参数：{"symbol": "BTC"}                                 │
│     │                                                       │
│     ▼                                                       │
│  3. 查找 MCP 配置                                           │
│     binance-local:                                          │
│       command: /opt/homebrew/bin/python3                    │
│       args: ["-m", "binance_mcp"]                           │
│       cwd: /Users/wangtao/exercise/crypto-currency-main     │
│     │                                                       │
│     ▼                                                       │
│  4. 启动子进程                                              │
│     fork() ──> 创建新进程 (PID: 5678)                       │
│     exec() ──> 执行 Python                                  │
│     │                                                       │
│     ▼                                                       │
│  ┌───────────────────────────────────────────────────┐     │
│  │  子进程 (PID: 5678)                               │     │
│  │  /opt/homebrew/bin/python3 -m binance_mcp        │     │
│  │                                                   │     │
│  │  1. 初始化 MCP 服务器                             │     │
│  │     - 注册工具                                    │     │
│  │     - 监听 stdin                                  │     │
│  │                                                   │     │
│  │  2. 等待请求                                      │     │
│  │     stdin ──> 读取 JSON-RPC 请求                  │     │
│  │                                                   │     │
│  │  3. 处理请求                                      │     │
│  │     {                                             │     │
│  │       "method": "tools/call",                     │     │
│  │       "params": {                                 │     │
│  │         "name": "get_spot_price",                 │     │
│  │         "arguments": {"symbol": "BTC"}            │     │
│  │       }                                           │     │
│  │     }                                             │     │
│  │     │                                             │     │
│  │     ▼                                             │     │
│  │  4. 调用币安 API                                  │     │
│  │     requests.get("https://api.binance.com/...")  │     │
│  │     │                                             │     │
│  │     ▼                                             │     │
│  │  5. 返回结果到 stdout                             │     │
│  │     {                                             │     │
│  │       "result": {                                 │     │
│  │         "symbol": "BTCUSDT",                      │     │
│  │         "price": 92731.52                         │     │
│  │       }                                           │     │
│  │     }                                             │     │
│  │     │                                             │     │
│  │     ▼                                             │     │
│  │  6. 进程退出                                      │     │
│  └───────────────────────────────────────────────────┘     │
│     │                                                       │
│     ▼                                                       │
│  5. Kiro 读取 stdout                                        │
│     │                                                       │
│     ▼                                                       │
│  6. 解析 JSON 响应                                          │
│     │                                                       │
│     ▼                                                       │
│  7. 显示给用户                                              │
│     "BTC 价格：$92,731.52"                                  │
└─────────────────────────────────────────────────────────────┘

总耗时：~1-2 秒
- 进程启动：~500ms
- Python 初始化：~300ms
- MCP 初始化：~200ms
- API 调用：~100ms
- 数据传输：~50ms
```


### 远程 MCP 详细流程

```
用户请求
   │
   ▼
┌─────────────────────────────────────────────────────────────┐
│  Kiro 进程 (PID: 1234) - 本地 Mac                           │
│                                                             │
│  1. 解析用户请求                                            │
│     "获取 BTC 价格"                                         │
│     │                                                       │
│     ▼                                                       │
│  2. 决定调用 MCP 工具                                       │
│     工具：get_spot_price                                    │
│     参数：{"symbol": "BTC"}                                 │
│     │                                                       │
│     ▼                                                       │
│  3. 查找 MCP 配置                                           │
│     binance-remote:                                         │
│       type: http                                            │
│       url: http://YOUR_SERVER_IP                              │
│     │                                                       │
│     ▼                                                       │
│  4. 构造 HTTP 请求                                          │
│     GET http://YOUR_SERVER_IP/binance/spot/price?symbol=BTC   │
│     │                                                       │
│     ▼                                                       │
│  5. 发送 HTTP 请求                                          │
│     - DNS 解析：YOUR_SERVER_IP                                │
│     - TCP 连接：建立连接                                    │
│     - HTTP 请求：发送 GET 请求                              │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       │ 网络传输 (~50ms)
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  服务器 (YOUR_SERVER_IP) - 新加坡                             │
│                                                             │
│  ┌───────────────────────────────────────────────────┐     │
│  │  Nginx (PID: 1234)                                │     │
│  │  - 接收请求                                       │     │
│  │  - 转发到 127.0.0.1:8080                          │     │
│  └────────────────────┬──────────────────────────────┘     │
│                       │                                     │
│                       ▼                                     │
│  ┌───────────────────────────────────────────────────┐     │
│  │  Flask App (PID: 3899)                            │     │
│  │  - 已经运行中（无需启动）                         │     │
│  │  - 监听 127.0.0.1:8080                            │     │
│  │                                                   │     │
│  │  1. 接收请求                                      │     │
│  │     GET /binance/spot/price?symbol=BTC            │     │
│  │     │                                             │     │
│  │     ▼                                             │     │
│  │  2. 路由匹配                                      │     │
│  │     @app.route('/binance/spot/price')             │     │
│  │     │                                             │     │
│  │     ▼                                             │     │
│  │  3. 提取参数                                      │     │
│  │     symbol = 'BTC'                                │     │
│  │     │                                             │     │
│  │     ▼                                             │     │
│  │  4. 调用函数                                      │     │
│  │     get_spot_price('BTC')                         │     │
│  │     │                                             │     │
│  │     ▼                                             │     │
│  │  5. 调用币安 API                                  │     │
│  │     requests.get("https://api.binance.com/...")  │     │
│  │     - 服务器在新加坡                              │     │
│  │     - 到币安服务器延迟 ~20ms                      │     │
│  │     │                                             │     │
│  │     ▼                                             │     │
│  │  6. 返回 JSON                                     │     │
│  │     {                                             │     │
│  │       "symbol": "BTCUSDT",                        │     │
│  │       "price": 92731.52,                          │     │
│  │       "price_formatted": "$92,731.5200"           │     │
│  │     }                                             │     │
│  └───────────────────────────────────────────────────┘     │
│                       │                                     │
│                       ▼                                     │
│  ┌───────────────────────────────────────────────────┐     │
│  │  Nginx                                            │     │
│  │  - 接收响应                                       │     │
│  │  - 添加响应头                                     │     │
│  │  - 返回给客户端                                   │     │
│  └───────────────────────────────────────────────────┘     │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       │ 网络传输 (~50ms)
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  Kiro 进程 - 本地 Mac                                       │
│                                                             │
│  6. 接收 HTTP 响应                                          │
│     │                                                       │
│     ▼                                                       │
│  7. 解析 JSON                                               │
│     │                                                       │
│     ▼                                                       │
│  8. 显示给用户                                              │
│     "BTC 价格：$92,731.52"                                  │
└─────────────────────────────────────────────────────────────┘

总耗时：~150ms
- 网络往返：~100ms (50ms * 2)
- 服务器处理：~30ms
- API 调用：~20ms
```

### 性能对比

**首次调用**：
- 本地 MCP：~1500ms（需要启动进程）
- 远程 MCP：~150ms（服务已运行）

**后续调用**：
- 本地 MCP：~1500ms（每次都启动新进程）
- 远程 MCP：~150ms（复用连接）

**并发调用**：
- 本地 MCP：每个调用启动一个进程，资源消耗大
- 远程 MCP：服务器统一处理，可以优化

### 何时使用本地 MCP

1. **开发调试**：
   - 修改代码后立即测试
   - 查看详细日志
   - 使用调试器

2. **隐私敏感**：
   - 不想数据经过网络
   - 使用私有 API 密钥

3. **离线工作**：
   - 没有网络连接
   - 服务器维护期间

### 何时使用远程 MCP

1. **生产使用**：
   - 稳定可靠
   - 性能更好
   - 24/7 可用

2. **多设备**：
   - 在不同电脑使用
   - 团队共享

3. **资源受限**：
   - 本地电脑性能不足
   - 节省本地资源

4. **API 速度**：
   - 服务器靠近交易所
   - 网络延迟更低

---

## 后续更新部署

### 方法 1：使用部署脚本（推荐）

最简单的方式是使用我们创建的 `deploy_simple.sh`：

```bash
# 在本地项目目录执行
./deploy_simple.sh
```

**脚本做了什么**：

1. 使用 rsync 上传变更的文件
2. SSH 到服务器执行部署脚本
3. 重启服务
4. 测试 API

**完整流程**：

```bash
# 1. 修改代码
vim binance_mcp.py

# 2. 本地测试（可选）
python3 mcp_http_server.py
curl http://localhost:8080/binance/spot/price?symbol=BTC

# 3. 部署到服务器
./deploy_simple.sh

# 4. 验证部署
curl http://YOUR_SERVER_IP/binance/spot/price?symbol=BTC
```

### 方法 2：手动部署

如果需要更多控制，可以手动执行每个步骤：

#### 步骤 1：上传文件

```bash
# 上传单个文件
scp binance_mcp.py root@YOUR_SERVER_IP:/opt/mcp-crypto-api/

# 上传整个目录
rsync -avz --exclude '__pycache__' --exclude '*.pyc' \
    ./* root@YOUR_SERVER_IP:/opt/mcp-crypto-api/
```

#### 步骤 2：SSH 到服务器

```bash
ssh root@YOUR_SERVER_IP
```

#### 步骤 3：更新依赖（如果 requirements.txt 变化）

```bash
cd /opt/mcp-crypto-api
source venv/bin/activate
pip install -r requirements.txt
```

#### 步骤 4：重启服务

```bash
supervisorctl restart mcp-crypto-api
```

#### 步骤 5：查看日志

```bash
# 查看最新日志
tail -50 /var/log/mcp-crypto-api.out.log

# 实时查看日志
tail -f /var/log/mcp-crypto-api.out.log

# 查看错误日志
tail -50 /var/log/mcp-crypto-api.err.log
```

#### 步骤 6：测试

```bash
# 在服务器上测试
curl http://localhost/health

# 退出服务器
exit

# 在本地测试
curl http://YOUR_SERVER_IP/health
```


### 方法 3：使用 Git 自动化部署

这是最专业的方式，适合团队协作。

#### 初始设置

**在本地**：

```bash
# 初始化 Git 仓库（如果还没有）
git init
git add .
git commit -m "Initial commit"

# 添加远程仓库（GitHub/GitLab）
git remote add origin https://github.com/your-username/mcp-crypto-api.git
git push -u origin main
```

**在服务器上**：

```bash
# 克隆仓库
cd /opt
git clone https://github.com/your-username/mcp-crypto-api.git
cd mcp-crypto-api

# 运行初始部署
./quick_deploy.sh
```

#### 日常更新流程

**在本地**：

```bash
# 1. 修改代码
vim binance_mcp.py

# 2. 提交更改
git add binance_mcp.py
git commit -m "优化价格查询功能"

# 3. 推送到远程仓库
git push origin main
```

**在服务器上**：

```bash
# 1. SSH 到服务器
ssh root@YOUR_SERVER_IP

# 2. 拉取最新代码
cd /opt/mcp-crypto-api
git pull origin main

# 3. 重启服务
supervisorctl restart mcp-crypto-api

# 4. 查看日志确认
tail -f /var/log/mcp-crypto-api.out.log
```

#### 配置 Git Hooks 自动重启

创建 Git Hook，拉取代码后自动重启服务：

```bash
# 在服务器上
cd /opt/mcp-crypto-api
cat > .git/hooks/post-merge << 'EOF'
#!/bin/bash
echo "代码已更新，重启服务..."
supervisorctl restart mcp-crypto-api
echo "服务已重启"
EOF

chmod +x .git/hooks/post-merge
```

现在每次 `git pull` 后会自动重启服务。

### 方法 4：创建管理脚本

创建一个本地管理脚本，简化常用操作：

```bash
# server_manager.sh 已经创建好了
chmod +x server_manager.sh
./server_manager.sh
```

**菜单选项**：

```
请选择操作：
1) 部署/更新代码到服务器
2) 查看服务状态
3) 重启服务
4) 查看实时日志
5) 测试 API
6) SSH 连接到服务器
7) 查看服务器资源使用
0) 退出
```

### 零停机部署（高级）

如果需要零停机更新，可以使用以下策略：

#### 方案 1：使用 Gunicorn 的优雅重启

```bash
# 安装 Gunicorn
pip install gunicorn

# 修改 Supervisor 配置
cat > /etc/supervisor/conf.d/mcp-crypto-api.conf <<EOF
[program:mcp-crypto-api]
directory=/opt/mcp-crypto-api
command=/opt/mcp-crypto-api/venv/bin/gunicorn \
    -w 4 \
    -b 127.0.0.1:8080 \
    --reload \
    mcp_http_server:app
user=root
autostart=true
autorestart=true
stderr_logfile=/var/log/mcp-crypto-api.err.log
stdout_logfile=/var/log/mcp-crypto-api.out.log
EOF

# 重启服务
supervisorctl reread
supervisorctl update
supervisorctl restart mcp-crypto-api
```

**Gunicorn 优势**：
- 多进程处理请求
- 优雅重启（不中断现有请求）
- 更好的性能

**优雅重启**：
```bash
# 发送 HUP 信号，Gunicorn 会优雅重启
kill -HUP $(cat /tmp/gunicorn.pid)
```

#### 方案 2：蓝绿部署

```bash
# 运行两个实例
# 实例 1：端口 8080
# 实例 2：端口 8081

# Nginx 配置负载均衡
upstream mcp_backend {
    server 127.0.0.1:8080;
    server 127.0.0.1:8081;
}

# 更新流程：
# 1. 更新实例 2 的代码
# 2. 重启实例 2
# 3. 测试实例 2
# 4. 更新实例 1 的代码
# 5. 重启实例 1
```

### 回滚策略

如果更新出现问题，需要快速回滚：

#### 使用 Git 回滚

```bash
# 在服务器上
cd /opt/mcp-crypto-api

# 查看提交历史
git log --oneline

# 回滚到上一个版本
git reset --hard HEAD~1

# 或回滚到特定提交
git reset --hard abc123

# 重启服务
supervisorctl restart mcp-crypto-api
```

#### 使用备份回滚

```bash
# 部署前备份
cp -r /opt/mcp-crypto-api /opt/mcp-crypto-api.backup.$(date +%Y%m%d_%H%M%S)

# 回滚
rm -rf /opt/mcp-crypto-api
mv /opt/mcp-crypto-api.backup.20250119_120000 /opt/mcp-crypto-api
supervisorctl restart mcp-crypto-api
```

### 更新检查清单

每次更新前检查：

- [ ] 代码在本地测试通过
- [ ] 依赖版本兼容
- [ ] 备份当前版本
- [ ] 通知用户（如果是重大更新）
- [ ] 准备回滚方案

更新后验证：

- [ ] 服务正常启动
- [ ] API 响应正常
- [ ] 日志无错误
- [ ] 性能无下降
- [ ] 功能测试通过

---

## 故障排查

### 常见问题和解决方案

#### 问题 1：服务无法启动

**症状**：
```bash
supervisorctl status mcp-crypto-api
# 输出：mcp-crypto-api  FATAL  Exited too quickly
```

**排查步骤**：

1. **查看错误日志**：
```bash
tail -100 /var/log/mcp-crypto-api.err.log
```

2. **常见错误**：

**错误 A：模块导入失败**
```
ModuleNotFoundError: No module named 'flask'
```

**解决方案**：
```bash
cd /opt/mcp-crypto-api
source venv/bin/activate
pip install -r requirements.txt
```

**错误 B：端口被占用**
```
OSError: [Errno 98] Address already in use
```

**解决方案**：
```bash
# 查找占用端口的进程
netstat -tlnp | grep 8080

# 杀死进程
kill -9 <PID>

# 或修改端口
vim mcp_http_server.py
# 修改：port = int(os.environ.get('PORT', 8081))
```

**错误 C：权限问题**
```
PermissionError: [Errno 13] Permission denied
```

**解决方案**：
```bash
# 修改文件权限
chmod +x /opt/mcp-crypto-api/mcp_http_server.py

# 或修改目录所有者
chown -R root:root /opt/mcp-crypto-api
```

3. **手动测试**：
```bash
cd /opt/mcp-crypto-api
source venv/bin/activate
python mcp_http_server.py
# 查看详细错误信息
```

#### 问题 2：API 返回 502 Bad Gateway

**症状**：
```bash
curl http://YOUR_SERVER_IP/health
# 输出：<html><body>502 Bad Gateway</body></html>
```

**原因**：Nginx 无法连接到后端 Flask 应用

**排查步骤**：

1. **检查 Flask 是否运行**：
```bash
supervisorctl status mcp-crypto-api
# 应该显示 RUNNING

ps aux | grep mcp_http_server
# 应该看到 Python 进程
```

2. **检查端口监听**：
```bash
netstat -tlnp | grep 8080
# 应该显示：tcp  0  0  127.0.0.1:8080  0.0.0.0:*  LISTEN
```

3. **测试本地连接**：
```bash
curl http://127.0.0.1:8080/health
# 应该返回 JSON
```

4. **检查 Nginx 配置**：
```bash
nginx -t
# 应该显示：syntax is ok

cat /etc/nginx/sites-enabled/mcp-crypto-api
# 检查 proxy_pass 是否正确
```

5. **查看 Nginx 日志**：
```bash
tail -50 /var/log/nginx/error.log
```


#### 问题 3：API 响应慢

**症状**：
```bash
time curl http://YOUR_SERVER_IP/binance/spot/price?symbol=BTC
# 输出：real  0m5.234s  (超过 5 秒)
```

**排查步骤**：

1. **检查服务器资源**：
```bash
# CPU 使用率
top

# 内存使用
free -h

# 磁盘 I/O
iostat -x 1
```

2. **检查网络延迟**：
```bash
# 从本地到服务器
ping YOUR_SERVER_IP

# 从服务器到币安 API
ssh root@YOUR_SERVER_IP
ping api.binance.com
```

3. **查看应用日志**：
```bash
tail -f /var/log/mcp-crypto-api.out.log
# 查看是否有慢查询或错误
```

4. **优化方案**：

**方案 A：添加缓存**
```python
from flask_caching import Cache

cache = Cache(app, config={'CACHE_TYPE': 'simple'})

@app.route('/binance/spot/price', methods=['GET'])
@cache.cached(timeout=10)  # 缓存 10 秒
def binance_spot_price():
    # ...
```

**方案 B：使用连接池**
```python
import requests
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry

session = requests.Session()
retry = Retry(total=3, backoff_factor=0.1)
adapter = HTTPAdapter(max_retries=retry, pool_connections=10, pool_maxsize=20)
session.mount('http://', adapter)
session.mount('https://', adapter)

# 使用 session 而不是 requests
response = session.get(url)
```

**方案 C：升级服务器配置**
```bash
# 从 1 vCPU, 2GB RAM 升级到 2 vCPU, 4GB RAM
```

#### 问题 4：无法 SSH 连接

**症状**：
```bash
ssh root@YOUR_SERVER_IP
# 输出：Connection timed out
```

**排查步骤**：

1. **检查服务器是否在线**：
```bash
ping YOUR_SERVER_IP
# 如果无响应，服务器可能关机或网络问题
```

2. **检查防火墙**：
```bash
# 在 Vultr 控制面板检查防火墙规则
# 确保端口 22 开放
```

3. **检查 SSH 服务**：
```bash
# 通过 Vultr 控制台登录
systemctl status sshd
# 应该显示 active (running)

# 如果未运行
systemctl start sshd
systemctl enable sshd
```

4. **检查 SSH 配置**：
```bash
cat /etc/ssh/sshd_config
# 确保：
# Port 22
# PermitRootLogin yes
# PasswordAuthentication yes
```

5. **重启 SSH 服务**：
```bash
systemctl restart sshd
```

#### 问题 5：MCP 工具无法调用

**症状**：
在 Kiro 中调用 MCP 工具时报错或无响应

**排查步骤**：

1. **检查 MCP 配置**：
```bash
cat ~/.kiro/settings/mcp.json
# 确保 URL 正确
# 确保 type 为 "http"
```

2. **测试 API 可访问性**：
```bash
curl http://YOUR_SERVER_IP/health
# 应该返回 JSON

curl http://YOUR_SERVER_IP/
# 应该返回 API 文档
```

3. **检查 autoApprove 列表**：
```json
{
  "autoApprove": [
    "get_spot_price",  // 确保工具名称正确
    "get_ticker_24h"
  ]
}
```

4. **查看 Kiro MCP 日志**：
- 在 Kiro 中打开输出面板
- 选择 "MCP" 频道
- 查看连接和调用日志

5. **重新加载 MCP 服务器**：
- 在 Kiro 命令面板（Cmd+Shift+P）
- 搜索 "MCP: Restart All Servers"
- 或重启 Kiro

#### 问题 6：币安 API 调用失败

**症状**：
```bash
curl http://YOUR_SERVER_IP/binance/spot/price?symbol=BTC
# 输出：{"error": "API request failed"}
```

**排查步骤**：

1. **检查币安 API 状态**：
```bash
# 直接测试币安 API
curl https://api.binance.com/api/v3/ping
# 应该返回：{}

curl https://api.binance.com/api/v3/time
# 应该返回时间戳
```

2. **检查服务器网络**：
```bash
ssh root@YOUR_SERVER_IP
ping api.binance.com
# 应该有响应

curl -I https://api.binance.com
# 应该返回 HTTP 200
```

3. **检查 API 限流**：
```bash
# 查看应用日志
tail -100 /var/log/mcp-crypto-api.out.log | grep "429"
# 429 表示请求过多，被限流
```

**解决方案**：
```python
# 添加请求限流
import time
from functools import wraps

def rate_limit(calls_per_second=10):
    min_interval = 1.0 / calls_per_second
    last_called = [0.0]
    
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            elapsed = time.time() - last_called[0]
            if elapsed < min_interval:
                time.sleep(min_interval - elapsed)
            result = func(*args, **kwargs)
            last_called[0] = time.time()
            return result
        return wrapper
    return decorator

@rate_limit(calls_per_second=5)
def call_binance_api(url):
    return requests.get(url)
```

### 监控和告警

#### 设置健康检查

创建监控脚本：

```bash
cat > /opt/monitor.sh << 'EOF'
#!/bin/bash
# 健康检查脚本

URL="http://localhost/health"
EXPECTED="ok"

response=$(curl -s $URL | grep -o "$EXPECTED")

if [ "$response" != "$EXPECTED" ]; then
    echo "$(date): Health check failed!" >> /var/log/monitor.log
    # 发送告警（邮件、Slack 等）
    # 重启服务
    supervisorctl restart mcp-crypto-api
else
    echo "$(date): Health check passed" >> /var/log/monitor.log
fi
EOF

chmod +x /opt/monitor.sh
```

添加到 crontab：

```bash
# 每 5 分钟检查一次
crontab -e
# 添加：
*/5 * * * * /opt/monitor.sh
```

#### 日志轮转

防止日志文件过大：

```bash
cat > /etc/logrotate.d/mcp-crypto-api << 'EOF'
/var/log/mcp-crypto-api.*.log {
    daily
    rotate 7
    compress
    delaycompress
    notifempty
    create 0640 root root
    sharedscripts
    postrotate
        supervisorctl restart mcp-crypto-api > /dev/null
    endscript
}
EOF
```

#### 性能监控

使用 Prometheus + Grafana（可选）：

```bash
# 安装 Prometheus Python 客户端
pip install prometheus-client

# 在 Flask 应用中添加指标
from prometheus_client import Counter, Histogram, generate_latest

request_count = Counter('http_requests_total', 'Total HTTP requests')
request_duration = Histogram('http_request_duration_seconds', 'HTTP request duration')

@app.route('/metrics')
def metrics():
    return generate_latest()
```

### 备份策略

#### 自动备份脚本

```bash
cat > /opt/backup.sh << 'EOF'
#!/bin/bash
# 备份脚本

BACKUP_DIR="/opt/backups"
PROJECT_DIR="/opt/mcp-crypto-api"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# 备份代码
tar -czf $BACKUP_DIR/mcp-crypto-api-$DATE.tar.gz \
    --exclude='venv' \
    --exclude='__pycache__' \
    $PROJECT_DIR

# 保留最近 7 天的备份
find $BACKUP_DIR -name "mcp-crypto-api-*.tar.gz" -mtime +7 -delete

echo "$(date): Backup completed: mcp-crypto-api-$DATE.tar.gz"
EOF

chmod +x /opt/backup.sh

# 每天凌晨 2 点备份
crontab -e
# 添加：
0 2 * * * /opt/backup.sh
```

#### 恢复备份

```bash
# 列出备份
ls -lh /opt/backups/

# 恢复备份
cd /opt
tar -xzf /opt/backups/mcp-crypto-api-20250119_020000.tar.gz

# 重启服务
supervisorctl restart mcp-crypto-api
```

### 安全加固

#### 1. 配置 HTTPS

```bash
# 安装 Certbot
apt install certbot python3-certbot-nginx -y

# 获取证书（需要域名）
certbot --nginx -d your-domain.com

# 自动续期
certbot renew --dry-run
```

#### 2. 添加 API 密钥认证

```python
from functools import wraps

API_KEY = "your-secret-api-key-here"

def require_api_key(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        key = request.headers.get('X-API-Key')
        if key != API_KEY:
            return jsonify({"error": "Invalid API key"}), 401
        return f(*args, **kwargs)
    return decorated_function

@app.route('/binance/spot/price', methods=['GET'])
@require_api_key
def binance_spot_price():
    # ...
```

#### 3. 限制访问 IP

在 Nginx 配置中：

```nginx
server {
    listen 80;
    
    # 只允许特定 IP
    allow 1.2.3.4;
    deny all;
    
    location / {
        proxy_pass http://127.0.0.1:8080;
    }
}
```

#### 4. 配置防火墙规则

```bash
# 只允许特定 IP 访问 SSH
ufw delete allow 22/tcp
ufw allow from 1.2.3.4 to any port 22

# 限制 HTTP 连接数
apt install fail2ban
```

---

## 总结

### 完整工作流程回顾

1. **开发阶段**：
   - 在本地 Mac 使用 Kiro + Claude 开发
   - 本地测试功能

2. **部署阶段**：
   - 配置 SSH 免密登录
   - 使用 rsync 上传文件
   - 执行 quick_deploy.sh 自动配置服务器
   - 验证部署成功

3. **配置阶段**：
   - 更新 MCP 配置为 HTTP 模式
   - 重新加载 MCP 服务器
   - 测试工具调用

4. **使用阶段**：
   - Kiro 通过 HTTP 调用远程 MCP
   - 服务器处理请求并返回结果
   - 24/7 稳定运行

5. **维护阶段**：
   - 使用 deploy_simple.sh 更新代码
   - 查看日志监控运行状态
   - 定期备份和安全检查

### 关键文件说明

- `mcp_http_server.py`：HTTP API 服务器
- `binance_mcp.py`：币安 MCP 功能实现
- `coingecko_mcp.py`：CoinGecko MCP 功能实现
- `requirements.txt`：Python 依赖列表
- `quick_deploy.sh`：服务器自动部署脚本
- `deploy_simple.sh`：本地一键部署脚本
- `~/.kiro/settings/mcp.json`：MCP 配置文件

### 常用命令速查

```bash
# 部署
./deploy_simple.sh

# SSH 连接
ssh root@YOUR_SERVER_IP

# 查看服务状态
ssh root@YOUR_SERVER_IP 'supervisorctl status'

# 查看日志
ssh root@YOUR_SERVER_IP 'tail -f /var/log/mcp-crypto-api.out.log'

# 重启服务
ssh root@YOUR_SERVER_IP 'supervisorctl restart mcp-crypto-api'

# 测试 API
curl http://YOUR_SERVER_IP/health
curl http://YOUR_SERVER_IP/binance/spot/price?symbol=BTC
```

### 获取帮助

如果遇到问题：

1. 查看本文档的故障排查部分
2. 检查服务器日志
3. 测试 API 端点
4. 验证配置文件
5. 重启服务尝试

---

**文档版本**：1.0  
**最后更新**：2025-01-19  
**服务器 IP**：YOUR_SERVER_IP  
**服务器位置**：新加坡  
**操作系统**：Ubuntu 24.04 LTS x64
